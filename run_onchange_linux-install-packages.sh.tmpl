{{- if (eq .chezmoi.os "linux") -}}

#!/bin/bash

echo "Installing packages"

sudo apt update

sudo apt install -y {{ range .packages.linux.apt }}{{ . }} {{ end }}

# Install httpstat (lightweight HTTP benchmarking tool)
echo "Installing httpstat..."
curl -fsSL https://raw.githubusercontent.com/reorx/httpstat/master/httpstat.py > /tmp/httpstat
sudo install /tmp/httpstat /usr/local/bin/httpstat
rm /tmp/httpstat

# Install AWS CLI v2 (official installer)
if ! command -v aws &> /dev/null; then
    echo "Installing AWS CLI v2..."
    curl "https://awscli.amazonaws.com/awscli-exe-linux-$(uname -m).zip" -o "/tmp/awscliv2.zip"
    unzip -q /tmp/awscliv2.zip -d /tmp
    sudo /tmp/aws/install
    rm -rf /tmp/awscliv2.zip /tmp/aws
else
    echo "AWS CLI already installed"
fi

# Install bun
curl -fsSL https://bun.sh/install | bash

echo "Installing Bun global packages..."

{{ range .packages.bun.global -}}
bun install --global {{ . | quote }}
{{ end -}}

# Install/Update Neovim to latest release
echo "Checking for latest Neovim release..."
NVIM_LATEST_VERSION=$(curl -s "https://api.github.com/repos/neovim/neovim/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')

# Get currently installed version (if any)
if command -v nvim &> /dev/null; then
    NVIM_CURRENT_VERSION=$(nvim --version | head -n1 | grep -Po 'v\K[0-9]+\.[0-9]+\.[0-9]+')
    echo "Current Neovim version: ${NVIM_CURRENT_VERSION}"
else
    NVIM_CURRENT_VERSION="none"
    echo "Neovim not currently installed"
fi

echo "Latest Neovim version: ${NVIM_LATEST_VERSION}"

# Compare versions and install if newer version available
if [ "$NVIM_CURRENT_VERSION" != "$NVIM_LATEST_VERSION" ]; then
    echo "Installing Neovim ${NVIM_LATEST_VERSION}..."
{{- if (eq .chezmoi.arch "arm64") }}
    # For ARM64, download the ARM64 release
    curl -Lo /tmp/nvim-linux.tar.gz "https://github.com/neovim/neovim/releases/download/v${NVIM_LATEST_VERSION}/nvim-linux-arm64.tar.gz"
    NVIM_DIR="nvim-linux-arm64"
{{- else if (eq .chezmoi.arch "amd64") }}
    # For AMD64, download the x86_64 release
    curl -Lo /tmp/nvim-linux.tar.gz "https://github.com/neovim/neovim/releases/download/v${NVIM_LATEST_VERSION}/nvim-linux-x86_64.tar.gz"
    NVIM_DIR="nvim-linux-x86_64"
{{- end }}
    sudo rm -rf /opt/${NVIM_DIR}
    sudo tar -C /opt -xzf /tmp/nvim-linux.tar.gz
    sudo ln -sf /opt/${NVIM_DIR}/bin/nvim /usr/local/bin/nvim
    rm /tmp/nvim-linux.tar.gz
    echo "Neovim ${NVIM_LATEST_VERSION} installed successfully"
else
    echo "Neovim is already at the latest version (${NVIM_CURRENT_VERSION})"
fi

{{- if (eq .chezmoi.arch "amd64") }}
LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
tar xf lazygit.tar.gz lazygit
sudo install lazygit /usr/local/bin
rm lazygit.tar.gz
{{- end }}

{{- if (eq .chezmoi.arch "arm64") }}
LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_arm64.tar.gz"
tar xf lazygit.tar.gz lazygit
sudo install lazygit /usr/local/bin
rm lazygit.tar.gz

printf '\nInstalling Laravel-ls..\n'

go install github.com/laravel-ls/laravel-ls/cmd/laravel-ls@latest
{{- end }}

{{- end }}
